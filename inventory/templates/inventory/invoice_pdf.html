{% load humanize %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Invoice {{ invoice.invoice_number }}</title>
    <style>
        /* Basic CSS for PDF - Reuse or adapt styles from receipt_pdf.html */
        @page {
            size: A4;
            margin: 1.5cm;
        }
        body {
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            font-size: 10pt;
            line-height: 1.4;
            color: #333;
        }
        h1, h2, h3, h4, h5, h6 {
            font-weight: bold;
            margin-bottom: 0.5em;
        }
        h1 { font-size: 18pt; }
        h2 { font-size: 14pt; }
        h5 { font-size: 11pt; }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1em;
        }
        th, td {
            border: 1px solid #ccc;
            padding: 6px 8px;
            text-align: left;
            vertical-align: top;
        }
        th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        .text-end { text-align: right; }
        .fw-bold { font-weight: bold; }
        .text-danger { color: #dc3545; }
        .notes {
            margin-top: 20px;
            padding: 10px;
            border: 1px solid #eee;
            background-color: #f9f9f9;
            font-size: 9pt;
        }
        .header-info { margin-bottom: 20px; }
        .header-info p { margin: 2px 0; }
        .totals tfoot td { border-top: 1px solid #eee; } /* Lighter line for intermediate totals */
        .totals tfoot .grand-total-row td { border-top: 2px solid #555; font-size: 12pt;}

    </style>
</head>
<body>

    <h1>Sales Invoice</h1>
    <hr>

    <div class="header-info">
        <p><strong>Invoice Number:</strong> {{ invoice.invoice_number }}</p>
        <p><strong>Customer:</strong> {{ invoice.customer_name|default:"N/A" }}</p>
        <p><strong>Sale Date:</strong> {{ invoice.sale_date|date:"F j, Y" }}</p>
        <p><strong>Due Date:</strong> {{ invoice.due_date|date:"F j, Y"|default:"N/A" }}</p>
        <p><strong>Generated By:</strong> {{ request.user.username|default:"System" }} on {% now "F j, Y H:i" %}</p>
    </div>

    <h5>Items Sold</h5>
    <table class="items">
        <thead>
            <tr>
                <th>Product</th>
                <th class="text-end">Quantity</th>
                <th class="text-end">Unit Price</th>
                <th class="text-end">Line Total</th>
            </tr>
        </thead>
        <tbody>
            {% for item in invoice.items.all %}
            <tr>
                <td>
                    {{ item.product.name }}
                    {% if item.product.sku %}<small style="color: #666; display: block;">(SKU: {{ item.product.sku }})</small>{% endif %}
                </td>
                <td class="text-end">{{ item.quantity }}</td>
                <td class="text-end">Ush {{ item.unit_price|floatformat:2| intcomma }}</td>
                <td class="text-end">Ush {% widthratio item.quantity 1 item.unit_price %}</td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="4" style="text-align: center; padding: 20px;">No items found on this invoice.</td>
            </tr>
            {% endfor %}
        </tbody>
        <tfoot class="totals">
           <tr>
               <td colspan="3" class="text-end fw-bold">Subtotal:</td>
               <td class="text-end">Ush {{ invoice.sub_total|floatformat:2| intcomma }}</td>
           </tr>
            {% if invoice.discount_amount > 0 %}
            <tr>
                <td colspan="3" class="text-end">Discount ({{ invoice.discount_rate|floatformat:2 }}%):</td>
                <td class="text-end text-danger">-Ush {{ invoice.discount_amount|floatformat:2| intcomma  }}</td>
            </tr>
            {% endif %}
             {% if invoice.tax_amount > 0 %}
            <tr>
                <td colspan="3" class="text-end">Tax ({{ invoice.tax_rate|floatformat:2 }}%):</td>
                <td class="text-end">Ush {{ invoice.tax_amount|floatformat:2| intcomma }}</td>
            </tr>
             {% endif %}
           <tr class="grand-total-row fw-bold">
               <td colspan="3" class="text-end">Total Amount Due:</td>
               <td class="text-end">Ush {{ invoice.total_amount|floatformat:2| intcomma }}</td>
           </tr>
        </tfoot>
    </table>

    {% if invoice.notes %}
        <div class="notes">
            <h5>Notes</h5>
            <p>{{ invoice.notes|linebreaksbr }}</p>
        </div>
    {% endif %}

</body>
</html>